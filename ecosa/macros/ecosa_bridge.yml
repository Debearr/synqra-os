macros:
  - name: "ECOSA Build Cursor Package"
    trigger: "on_commit"
    source: "/cursor/agents"
    tasks:
      - name: "Assemble Cursor Package"
        run: "bash scripts/cursor_packager.sh"
      - name: "Verify Package Integrity"
        run: "bash scripts/cursor_integrity_check.sh"
      - name: "Deploy to Cursor"
        run: "cursor package install --auto latest_build.zip"
    safety:
      retries: 3
      timeout: 90
      on_fail: "bash scripts/ecosa_autofix.sh"
    notify:
      success: "Supabase:insert build_logs {status:'success',app:'{{app_name}}'}"
      fail: "Supabase:insert build_logs {status:'failed',app:'{{app_name}}'}"

  - name: "Verify Cursor Package Integrity"
    trigger: "scheduled"
    schedule: "0 */6 * * *"
    tasks:
      - name: "Checksum Validation"
        run: "bash scripts/cursor_integrity_check.sh"
      - name: "Auto-Repair if Drift Detected"
        condition: "if diff_found"
        run: "bash scripts/ecosa_autofix.sh"
    notify:
      success: "Supabase:update health_status {integrity:'pass'}"
      fail: "Supabase:update health_status {integrity:'repaired'}"

  - name: "Auto-Redeploy on Failure"
    trigger: "on_macro_fail"
    tasks:
      - name: "Rebuild & Redeploy"
        run: "bash scripts/cursor_packager.sh && cursor package install --force latest_build.zip"
      - name: "Post-Repair Verification"
        run: "bash scripts/cursor_integrity_check.sh"
    safety:
      retries: 2
      cooldown: 60
    notify:
      success: "Supabase:insert recovery_logs {event:'auto_redeploy_success'}"
      fail: "Supabase:insert recovery_logs {event:'manual_attention_required'}"
