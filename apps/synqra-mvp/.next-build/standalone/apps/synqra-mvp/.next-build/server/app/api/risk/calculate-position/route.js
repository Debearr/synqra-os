(()=>{var e={};e.id=1746,e.ids=[1746,4291],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},4271:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>_,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>S,workUnitAsyncStorage:()=>A});var s={};r.r(s),r.d(s,{POST:()=>E});var a=r(1271),o=r(1232),n=r(8079),i=r(1238),l=r(1525),u=r(4291);let c={maxRiskPerTrade:.02,maxDailyLoss:.05,maxWeeklyLoss:.1,maxTradesPerDay:10,maxConsecutiveLosses:3};var p=r(6357);async function d(e){var t,r;if((t=e.accountState,r=e.limits,t.isLocked?{locked:!0,message:"Account is locked."}:t.currentDailyPnL<=-r.maxDailyLoss*t.balance?{locked:!0,message:"Daily loss limit reached."}:t.consecutiveLosses>=r.maxConsecutiveLosses?{locked:!0,message:"Maximum consecutive losses reached."}:{locked:!1}).locked)return{lots:0,riskAmount:0,isLocked:!0,message:"SESSION LOCKED: DAILY DRAWDOWN LIMIT REACHED. RECOVER MENTAL CAPITAL."};let s=function(e,t,r){let s=t.balance*r.maxRiskPerTrade,a=Math.abs((e.entry??(e.entryZone?(e.entryZone.low+e.entryZone.high)/2:0))-(e.stop??e.stopLoss??0));return{allowed:!0,positionSize:Math.max(0,Math.min(a>0?s/a:0,.1*t.balance)),riskAmount:s,reason:"Position size calculation pending full implementation"}}(e.signal,e.accountState,e.limits);return{lots:s.positionSize,riskAmount:s.riskAmount,isLocked:!1,message:s.reason}}async function E(e){try{let t=e.headers.get("authorization");if(!t)return i.NextResponse.json({error:"Unauthorized"},{status:401});let r=(0,l.createClient)((0,u.getSupabaseUrl)(),(0,u.getSupabaseAnonKey)(),{global:{headers:{Authorization:t}}}),{data:{user:s}}=await r.auth.getUser();if(!s)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{signal:a,accountBalance:o,riskPercent:n}=await e.json();if(!a||!o)return i.NextResponse.json({error:"Signal and accountBalance required"},{status:400});let{data:p,error:E}=await r.from("user_accounts").select("daily_pnl, daily_loss_limit, is_locked").eq("user_id",s.id).single();if(E)return i.NextResponse.json({error:"Account not found"},{status:404});if(p?.is_locked||p?.daily_pnl!==null&&p?.daily_loss_limit!==null&&void 0!==p?.daily_pnl&&void 0!==p?.daily_loss_limit&&p.daily_pnl<=-p.daily_loss_limit)return i.NextResponse.json({allowed:!1,lots:0,message:"SESSION LOCKED: DAILY DRAWDOWN LIMIT REACHED. RECOVER MENTAL CAPITAL."},{status:200});let m={balance:o,currentDailyPnL:"number"==typeof p?.daily_pnl?p.daily_pnl:0,currentWeeklyPnL:0,tradesToday:0,consecutiveLosses:0,isLocked:!1},S=n||c.maxRiskPerTrade,A={...c,maxRiskPerTrade:S},y=await d({userId:s.id,signal:a,accountState:m,limits:A});return i.NextResponse.json(y,{status:200})}catch(e){return console.error("Position calculation error:",e),i.NextResponse.json({error:p.d},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/risk/calculate-position/route",pathname:"/api/risk/calculate-position",filename:"route",bundlePath:"app/api/risk/calculate-position/route"},resolvedPagePath:"C:\\Projects\\Synqra\\apps\\synqra-mvp\\app\\api\\risk\\calculate-position\\route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:S,workUnitAsyncStorage:A,serverHooks:y}=m;function _(){return(0,n.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:A})}},7032:()=>{},408:()=>{},6357:(e,t,r)=>{"use strict";r.d(t,{d:()=>s});let s="An unexpected error occurred. Please try again."},4291:(e,t,r)=>{"use strict";r.d(t,{F:()=>i,getSupabaseAnonKey:()=>n,getSupabaseUrl:()=>o});let s=["SUPABASE_SERVICE_KEY","SUPABASE_SERVICE_ROLE"];function a(e,t){if(!e||""===e.trim())throw Error(`[Supabase Env] ${t} is missing or empty`);return e}function o(){let e=a(process.env.SUPABASE_URL,"SUPABASE_URL");return function(e,t){try{let r=new URL(e);if("http:"!==r.protocol&&"https:"!==r.protocol)throw Error(`[Supabase Env] ${t} must start with http:// or https://`)}catch(e){throw Error(`[Supabase Env] ${t} is invalid: ${e instanceof Error?e.message:"Unknown URL error"}`)}}(e,"SUPABASE_URL"),e}function n(){return a(process.env.SUPABASE_ANON_KEY,"SUPABASE_ANON_KEY")}function i(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;if(e&&""!==e.trim())return e;for(let e of s){let t=process.env[e];if(t&&""!==t.trim())return console.warn(`[Supabase Env] Falling back to ${e}. Set SUPABASE_SERVICE_ROLE_KEY and restart.`),t}throw Error("[Supabase Env] SUPABASE_SERVICE_ROLE_KEY is missing or empty")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[6207,8048,1525],()=>r(4271));module.exports=s})();