name: Enterprise Health Cell System

on:
  schedule:
    # Run health checks every 5 minutes
    - cron: '*/5 * * * *'
    # Run daily aggregation at midnight UTC
    - cron: '0 0 * * *'
    # Run recovery every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      job:
        description: 'Which job to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - health-check
          - aggregate-daily
          - recovery
  push:
    branches: [main, claude/**]
    paths:
      - 'scripts/health-checks/**'
      - '.github/workflows/enterprise-health-cell.yml'

jobs:
  health-check:
    name: Run Enterprise Health Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Run on schedule, workflow_dispatch, or push
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.job == 'all' || github.event.inputs.job == 'health-check'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'scripts/health-checks/package.json'

      - name: Validate environment variables
        run: |
          echo "ğŸ” Validating required secrets..."
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âŒ ERROR: SUPABASE_URL secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "âŒ ERROR: SUPABASE_SERVICE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… Required secrets are configured"

          if [ -z "${{ secrets.N8N_WEBHOOK_URL }}" ]; then
            echo "âš ï¸  WARNING: N8N_WEBHOOK_URL not set (optional)"
          else
            echo "âœ… N8N_WEBHOOK_URL configured"
          fi

      - name: Install dependencies
        working-directory: scripts/health-checks
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci || npm install
          echo "âœ… Dependencies installed"

      - name: Run enterprise health monitor
        working-directory: scripts/health-checks
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
        run: |
          echo "ğŸš€ Starting enterprise health monitor..."
          node enterprise-health-monitor.mjs
          echo "âœ… Health monitor completed"

      - name: Aggregate hourly metrics
        if: always()
        working-directory: scripts/health-checks
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ“Š Aggregating hourly metrics..."
          node --input-type=module -e "
          import { createClient } from '@supabase/supabase-js';
          const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);
          const { error } = await supabase.rpc('aggregate_health_metrics_hourly');
          if (error) {
            console.warn('âš ï¸  Metrics aggregation failed:', error.message);
            console.warn('This may be expected if the database function does not exist yet.');
          } else {
            console.log('âœ… Hourly metrics aggregated');
          }
          "

      - name: Upload health check logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-logs-${{ github.run_number }}
          path: scripts/health-checks/.healthcell/local-logs.jsonl
          retention-days: 7
          if-no-files-found: warn

      - name: Report status
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SUCCESS: All health checks passed"
            echo "   Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          else
            echo "âŒ FAILURE: Health checks failed"
            echo "   Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "   Alerts have been triggered"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  aggregate-daily-metrics:
    name: Aggregate Daily Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Run only on midnight UTC schedule or manual trigger
    if: (github.event.schedule == '0 0 * * *') || (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'aggregate-daily'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'scripts/health-checks/package.json'

      - name: Install dependencies
        working-directory: scripts/health-checks
        run: npm ci || npm install

      - name: Aggregate daily metrics
        working-directory: scripts/health-checks
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ“Š Aggregating daily metrics..."
          node --input-type=module -e "
          import { createClient } from '@supabase/supabase-js';
          const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);
          const { error } = await supabase.rpc('aggregate_health_metrics_daily');
          if (error) {
            console.error('âŒ Daily metrics aggregation failed:', error.message);
            process.exit(1);
          }
          console.log('âœ… Daily metrics aggregated successfully');
          "

      - name: Cleanup old logs
        working-directory: scripts/health-checks
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ§¹ Cleaning up old health logs..."
          node --input-type=module -e "
          import { createClient } from '@supabase/supabase-js';
          const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);
          const { error } = await supabase.rpc('cleanup_old_health_logs', { days_to_keep: 30 });
          if (error) {
            console.warn('âš ï¸  Log cleanup failed:', error.message);
            console.warn('This may be expected if the database function does not exist yet.');
          } else {
            console.log('âœ… Old logs cleaned up (30 day retention)');
          }
          "

      - name: Report completion
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SUCCESS: Daily aggregation completed"
          else
            echo "âŒ FAILURE: Daily aggregation failed"
          fi
          echo "   Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  recovery-automation:
    name: Recovery Automation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Run only on 15-minute schedule or manual trigger
    # NOTE: Recovery runs every 15 min, but only acts when services are degraded
    if: (github.event.schedule == '*/15 * * * *') || (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'all' || github.event.inputs.job == 'recovery'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'scripts/health-checks/package.json'

      - name: Install dependencies
        working-directory: scripts/health-checks
        run: npm ci || npm install

      - name: Run recovery automation
        working-directory: scripts/health-checks
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
        run: |
          echo "ğŸ”„ Starting recovery automation..."
          # Run recovery with timeout, but don't fail the job if it times out gracefully
          timeout 900 node recovery-automation.mjs || EXIT_CODE=$?

          if [ ${EXIT_CODE:-0} -eq 124 ]; then
            echo "âš ï¸  Recovery automation timed out after 15 minutes (expected for long-running process)"
            exit 0
          elif [ ${EXIT_CODE:-0} -ne 0 ]; then
            echo "âŒ Recovery automation failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          else
            echo "âœ… Recovery automation completed successfully"
            exit 0
          fi

      - name: Upload recovery logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: recovery-logs-${{ github.run_number }}
          path: scripts/health-checks/.healthcell/recovery-log.jsonl
          retention-days: 7
          if-no-files-found: warn

      - name: Report status
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SUCCESS: Recovery automation completed"
          else
            echo "âŒ FAILURE: Recovery automation encountered errors"
          fi
          echo "   Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  status-page:
    name: Update Status Page
    runs-on: ubuntu-latest
    needs: health-check
    if: always() && (github.event_name != 'workflow_dispatch' || github.event.inputs.job == 'all' || github.event.inputs.job == 'health-check')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate status badge
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ“Š Status page update placeholder"
          echo "Health check status: ${{ needs.health-check.result }}"
          # Future: Push to status page or update badge
          # This could integrate with Statuspage.io, Cachet, or custom dashboard
